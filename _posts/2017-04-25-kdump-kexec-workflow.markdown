---
layout: post
title:  "kdump/kexec Workflow in Fedora x86"
date:   2017-04-30 09:00:00 +0800
categories: Linux
tags: Computer_Science Linux Kernel kexec kdump
---

This post describes the detailed code control flow of kdump/kexec utilities in Fedora x86.

kdump is the utility for collecting kernel core dump when the kernel crashes. It makes use of `kexec` system call provided by Linux kernel to load a second kernel, in which dumping core process happens.

kdump's workflow in Fedora can be divided roughly into 4 phases:
* Loading the emergency kernel into memory
* Logic after kernel crashes and before emergency kernel boots
* Booting emergency kernel
* Dumping core

# **Loading the emergency kernel into memory**

After trigerring "systemctl start kdump.service":

1. `fedorapkg/kexec-tools/kdumpctl: start->start_dump->load_kdump`
    * load the crash kernel image into memory (user mode, script)
2. `upstream/kexec-tools/kexec/kexec.c: kexec_load`
    * load the crash kernel image into memory (user mode, C)
    * use syscall to perform `sys_kexec_load`
3. `linux/kernel/kexec.c: sys_kexec_load(SYSCALL_DEFINE4)`
    * load the crash kernel image into memory (kernel mode, C)
    * what about the comments before `sys_kexec_load`? I think they're outdated.

# **Logic after kernel crash and before emergency kernel boot**

1. `linux/kernel/panic.c: panic`
    * kernel panic.
2. `linux/kernel/reboot.c: sys_reboot(SYSCALL_DEFINE4)`
    * root reboot.
3. `linux/kernel/kexec_core.c: __crash_kexec`
    * called when panic.
4. `linux/kernel/kexec_core.c: kernel_kexec`
    * called when rebooting with flag `LINUX_REBOOT_CMD_KEXEC`.
5. linux/arch/x86/kernel/machine_kexec_32.c: machine_kexec
    * arch-specified code, called by `kernel_kexec` or `__crash_kexec`.
6. linux/arch/x86/kernel/relocate_kernel_32.S: relocate_kernel
    * put the kernel image in place to boot. the last step before emergency kernel boots.

# **Booting emergency kernel**
Boot into dracut-generated initramfs (specified by grub parameter). This image is generated by `kdumpctl` utility during starting kdump's service.

# **After booting into capture kernel**

1. `linux/fs/proc/vmcore.c: vmcore_init`
    * prepare /proc/vmcore when fs init.
2. `fedorapkg/kexec-tools/kdumpctl: main->save_core`
    * using makedumpfile to save vmcore, then reboot to the origin kernel.


# References:

* [使用 kexec 快速重启 Linux](https://www.ibm.com/developerworks/cn/linux/l-kexec/)
* [Kexecを使ってLinuxの起動を早める](https://www.ibm.com/developerworks/jp/linux/library/l-kexec/)
* [Fedora `kexec-tools` Source](git://pkgs.fedoraproject.org/kexec-tools.git)
* [Linux Source](git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git)
* [Linux Upstream `kexec-tools` Source](git://git.kernel.org/pub/scm/utils/kernel/kexec/kexec-tools.git)
* [Kdump, A Kexec-based Kernel Crash Dumping Mechanism](https://www.kernel.org/doc/ols/2005/ols2005v1-pages-177-188.pdf)
* [Kdump: Smarter, Easier, Trustier](https://www.kernel.org/doc/ols/2007/ols2007v1-pages-167-178.pdf)
* [kdump: usage and internals](http://events.linuxfoundation.org/sites/events/files/slides/kdump_usage_and_internals.pdf)